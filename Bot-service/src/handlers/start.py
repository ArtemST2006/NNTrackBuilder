from aiogram import Router, types
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext

from ..services.token_storage import token_storage
from ..utils.keyboards import get_main_menu_keyboard

router = Router()

@router.message(Command("start"))
async def cmd_start(message: types.Message, state: FSMContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
    
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –º–µ–Ω—é
    –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    await state.clear()
    
    user = message.from_user
    telegram_id = user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    token = token_storage.get_token(telegram_id)
    is_authenticated = token is not None
    
    if is_authenticated:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        welcome_text = f"""
üëã <b>–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {user.first_name}!</b>

‚úÖ –í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∏ –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã.

üéØ <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
‚Ä¢ /route ‚Äî –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç
‚Ä¢ /profile ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å  
‚Ä¢ /logout ‚Äî –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
‚Ä¢ /help ‚Äî –ü–æ–º–æ—â—å –ø–æ –∫–æ–º–∞–Ω–¥–∞–º

üöÄ <b>–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:</b>
–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞!
"""
        
    else:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        welcome_text = f"""
üëã <b>–ü—Ä–∏–≤–µ—Ç, {user.first_name}!</b>

ü§ñ –Ø ‚Äî <b>Nizhny Route Builder</b>, —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≥–∏–¥ –ø–æ –ù–∏–∂–Ω–µ–º—É –ù–æ–≤–≥–æ—Ä–æ–¥—É.

üéØ <b>–ß—Ç–æ —è —É–º–µ—é:</b>
‚Ä¢ –°–æ–∑–¥–∞–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
‚Ä¢ –£—á–∏—Ç—ã–≤–∞—Ç—å —Ç–≤–æ–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã (–∫–æ—Ñ–µ–π–Ω–∏, –º—É–∑–µ–∏, –ø–∞—Ä–∫–∏ –∏ –¥—Ä.)
‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –ø—Ä–æ–≥—É–ª–∫–∏
‚Ä¢ –ü–æ–¥–±–∏—Ä–∞—Ç—å –º–µ—Å—Ç–∞ —Ä—è–¥–æ–º —Å —Ç–æ–±–æ–π

üîê <b>–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞:</b>
1. –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç (–∫–Ω–æ–ø–∫–∞ –Ω–∏–∂–µ)
2. –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
3. –ü–æ–ª—É—á–∞–π—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π

üîÑ <b>–î–∞–∂–µ –±–µ–∑ –≤—Ö–æ–¥–∞:</b>
–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–µ–º–æ-–≤–µ—Ä—Å–∏—é!

üéØ <b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
‚Ä¢ /login ‚Äî –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
‚Ä¢ /route ‚Äî –î–µ–º–æ-–º–∞—Ä—à—Ä—É—Ç
‚Ä¢ /help ‚Äî –ü–æ–º–æ—â—å –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
‚Ä¢ /about ‚Äî –û –ø—Ä–æ–µ–∫—Ç–µ
"""
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
    await message.answer(
        welcome_text,
        reply_markup=get_main_menu_keyboard(is_authenticated)
    )


@router.message(Command("about"))
async def cmd_about(message: types.Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /about
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ
    """
    about_text = """
‚ÑπÔ∏è <b>–û –ø—Ä–æ–µ–∫—Ç–µ Nizhny Route Builder</b>

üéì <b>–£—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç</b> –ø–æ –∫—É—Ä—Å—É –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã—Ö –Ω–∞—É–∫
üë• <b>–ö–æ–º–∞–Ω–¥–∞:</b> 4 —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
üèóÔ∏è <b>–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:</b> –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã + Docker + Kafka
üó∫Ô∏è <b>–î–∞–Ω–Ω—ã–µ:</b> 50+ —Ä–µ–∞–ª—å–Ω—ã—Ö –º–µ—Å—Ç –ù–∏–∂–Ω–µ–≥–æ –ù–æ–≤–≥–æ—Ä–æ–¥–∞

üõ†Ô∏è <b>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:</b>
‚Ä¢ Python + FastAPI + Aiogram
‚Ä¢ PostgreSQL + SQLAlchemy
‚Ä¢ Apache Kafka –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
‚Ä¢ Docker –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏
‚Ä¢ WebSocket –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏

üîß <b>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</b>
‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ User Service –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è Telegram
‚úÖ API Gateway —Å WebSocket
‚è≥ AI Service –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
üîÑ Frontend WebApp –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

üìä <b>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞:</b>
‚Ä¢ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ JWT —Ç–æ–∫–µ–Ω—ã
‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
‚Ä¢ –£—á–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–∏
‚Ä¢ –†–µ–∞–ª—å–Ω–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
‚Ä¢ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ WebSocket

üí° <b>–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:</b>
–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –æ—Ç–∫—Ä—ã—Ç –¥–ª—è –æ–±—É—á–µ–Ω–∏—è.
–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∫–∞–∫ —à–∞–±–ª–æ–Ω –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.
"""
    
    await message.answer(about_text)


@router.message(lambda message: message.text == "‚ÑπÔ∏è –û –±–æ—Ç–µ")
async def about_button(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û –±–æ—Ç–µ" –∏–∑ –º–µ–Ω—é"""
    await cmd_about(message)


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
@router.message(lambda message: message.text == "üó∫Ô∏è –°–æ–∑–¥–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç")
async def create_route_button(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–æ–∑–¥–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç" –∏–∑ –º–µ–Ω—é"""
    from .route import cmd_route
    await cmd_route(message, state)


@router.message(lambda message: message.text == "üë§ –ü—Ä–æ—Ñ–∏–ª—å")
async def profile_button(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ—Ñ–∏–ª—å" –∏–∑ –º–µ–Ω—é"""
    from .auth import cmd_profile
    await cmd_profile(message)


@router.message(lambda message: message.text == "üîê –í–æ–π—Ç–∏")
async def login_button(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–í–æ–π—Ç–∏" –∏–∑ –º–µ–Ω—é"""
    from .auth import cmd_login
    await cmd_login(message, state)


@router.message(lambda message: message.text == "üö™ –í—ã–π—Ç–∏")
async def logout_button(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–í—ã–π—Ç–∏" –∏–∑ –º–µ–Ω—é"""
    from .auth import cmd_logout
    await cmd_logout(message)


@router.message(lambda message: message.text == "üó∫Ô∏è –î–µ–º–æ-–º–∞—Ä—à—Ä—É—Ç")
async def demo_route_button(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–î–µ–º–æ-–º–∞—Ä—à—Ä—É—Ç" –∏–∑ –º–µ–Ω—é"""
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ-–º–∞—Ä—à—Ä—É—Ç –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    await message.answer(
        "üöÄ <b>–î–µ–º–æ-—Ä–µ–∂–∏–º –º–∞—Ä—à—Ä—É—Ç–∞</b>\n\n"
        "–í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ –≤—ã –º–æ–∂–µ—Ç–µ —É–≤–∏–¥–µ—Ç—å –ø—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞.\n"
        "–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /route –¥–ª—è –¥–µ–º–æ-–º–∞—Ä—à—Ä—É—Ç–∞ –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç."
    )